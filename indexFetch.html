<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Registro de Evento</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
  <div class="container mt-5">
    <h1 class="text-center mb-4">Registro de Asistente</h1>

        <form id="eventoForm" class="needs-validation" novalidate>

            <div class="form-check mb-3">
        <input type="checkbox" name="terminos" class="form-check-input" id="terminos" required>
        <label for="terminos" class="form-check-label">Acepto los términos y condiciones</label>
        <div class="invalid-feedback">
            Debes aceptar los términos y condiciones.
        </div>
      </div>
                    <div class="text-center">
        <button type="submit" class="btn btn-primary">Enviar</button>
      </div>
    </form>

        <div id="resultado" class="mt-5"></div>
  </div>

  <script>
    // JS para la validación visual de Bootstrap
    (() => {
      'use strict'
      const forms = document.querySelectorAll('.needs-validation')
      Array.from(forms).forEach(form => {
        form.addEventListener('submit', event => {
          if (!form.checkValidity()) {
            event.preventDefault()
            event.stopPropagation()
          }
          form.classList.add('was-validated')
        }, false)
      })
    })()

    // JS para la llamada REST (FETCH)
    document.getElementById('eventoForm').addEventListener('submit', async e => {
      e.preventDefault();
      const form = e.target;

      // Comprobar la validación de Bootstrap antes de enviar
      if (!form.checkValidity()) {
        e.stopPropagation();
        form.classList.add('was-validated');
        return;
      }

      // Recolectar los datos (PERO ahora usamos FormData para incluir el archivo)
      const formData = new FormData(form);

      // Limpiamos el resultado anterior
      const resultadoDiv = document.getElementById('resultado');
      resultadoDiv.innerHTML = '<div class="alert alert-info">Enviando...</div>';

      try {
        // Enviar los datos a nuestra API-PHP.
        // NO enviamos JSON, enviamos "multipart/form-data" 
        // porque incluye un archivo.
        const res = await fetch('api_evento.php', {
          method: 'POST',
          // No se pone 'Content-Type', el navegador lo pone solo
          // con 'multipart/form-data' cuando usas FormData.
          body: formData 
        });

        // El servidor (api_evento.php) debe responder con JSON
        const result = await res.json();

        if (res.ok) { // HTTP 200-299
          // Éxito: Mostrar recibo
          let reciboHtml = '<ul class="list-group">';
          for (const [key, value] of Object.entries(result.data_recibida)) {
            reciboHtml += `<li class="list-group-item"><strong>${key}:</strong> ${value}</li>`;
          }
          reciboHtml += '</ul>';

          resultadoDiv.innerHTML = `
            <div class="alert alert-success">
              <h4>${result.message}</h4>
              ${reciboHtml}
            </div>`;
        } else { // HTTP 400, 500...
          // Error de validación del servidor
          let erroresHtml = '<ul>';
          result.errors.forEach(err => {
            erroresHtml += `<li>${err}</li>`;
          });
          erroresHtml += '</ul>';

          resultadoDiv.innerHTML = `
            <div class="alert alert-danger">
              <h4>${result.message}</h4>
              ${erroresHtml}
            </div>`;
        }

      } catch (error) {
        console.error('Error en fetch:', error);
        resultadoDiv.innerHTML = `
          <div class="alert alert-danger">
            <strong>Error de red:</strong> No se pudo conectar con el servidor.
          </div>`;
      }
    });
  </script>
</body>
</html>